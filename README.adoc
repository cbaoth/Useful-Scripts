:qa-section: ‚ùì

== Some random shell/python scripts

Created and intended for my personal use only. Some of these are ancient and most not well maintained, so if anyone stumbles upon this repo: Be warned, read/use at your own risk. :)

'''

=== bedtime-shutdown.sh - üò¥ Digital Detox: Bedtime Enforcer

If you find yourself doom-scrolling or debugging at 02:00 (2 AM), this script is your new best friend (or worst enemy). It forces a system shutdown at a set time every night to make sure you actually get some sleep.

==== How it works

* *The Warning:* At 21:30 (or whenever you schedule it), the script triggers and sends a "critical" notification to your desktop.
* *The Countdown:* It gives you a 180-second grace period (customizable via `GRACE_PERIOD_USER`, default: 3 min) to save your work and close your tabs.
* *The End:* Once the timer hits zero, it executes a hard `+systemctl poweroff --ignore-inhibitors+`. No "just 5 more minutes ..." allowed.
** _The `--ignore-inhibitors` ensures that inhibitors (e.g. "stay awake" tools like Caffeine) are ignored._
** _This bares the risk of data loss, but if you haven't saved your work in time, that's on you._
* *The Nuclear Option:* If for some reason the poweroff command gets stuck, the script will, after another grace period (customizable via `+GRACE_PERIOD_SYSTEM+`, default: 3 min), enforce an immediate "wait for nothing" poweroff by executing `+systemctl poweroff --force --force+`.
** *This is basically the software equivalent of pulling the power plug!*
** _This bares an even higher risk of data loss since services won't have time to gracefully stop and unmount filesystems properly. But ideally this stage should never be reached (just a safety net), and if it does, we trust that the system is able to recover from it._
** _If you think the risk is too high, this fallback step can easily be disabled by setting `+GRACE_PERIOD_SYSTEM=0+`._

==== üõ†Ô∏è Installation & Setup

Since this script handles system power, we need to set it up with root permissions and a systemd timer.

===== 1. Prep the Script

Copy the script to your local bin:

[source,shell]
----
sudo cp bedtime-shutdown.sh /opt/bin/bedtime-shutdown.sh
----

Open the script and make sure the values in the `+CONFIGURATION+` section fit your personal needs.

NOTE: Make sure that `+USER_NAME+` is set to your actual username (e.g., `+USER_NAME=yourname+`) and the time between `+SHUTDOWN_START+` and `+SHUTDOWN_END+` is your preferred "Bedtime Zone" (e.g., `+SHUTDOWN_START=2130+` and `+SHUTDOWN_END=0500+` to only shutdown between 21:30 to 05:00).

Lock down the permissions so only root can touch it:
[source,shell]
----
sudo chown root:root /opt/bin/bedtime-shutdown.sh
sudo chmod 700 /opt/bin/bedtime-shutdown.sh
----

===== 2. Create the Service

This tells the system what to run.

[source,shell]
----
sudo tee /etc/systemd/system/bedtime.service <<EOF
[Unit]
Description=Bedtime Shutdown Script
[Service]
Type=simple
ExecStart=/opt/bin/bedtime-shutdown.sh
EOF
----

===== 3. Create the Timer

This tells the system when to run it. Default is set to 21:30 (9:30 PM).

[source,shell]
----
sudo tee /etc/systemd/system/bedtime.timer <<EOF
[Unit]
Description=Run Bedtime Script at 21:30
[Timer]
OnCalendar=*-*-* 21:30:00
Persistent=true

[Install]
WantedBy=timers.target
EOF
----

NOTE: The timer is `+Persistent+`, meaning if your computer is off at the scheduled time, it will run the script as soon as you power it on again. To prevent the system from shutting down immediately after booting up in the morning, make sure the `+SHUTDOWN_START+` and `+SHUTDOWN_END+` times in the script are set correctly.

==== 4. Fire it up

Enable and start the timer:

[source,shell]
----
sudo systemctl enable --now bedtime.timer
----

=== ‚öôÔ∏è Customization

==== Applying Changes to Systemd Units

First of all, whenever either of the `/etc/systemd/system/bedtime.*` files are changed, ensure to reload the systemd daemon and restart the relevant unit(s):

[source,shell]
----
sudo systemctl daemon-reload

# for changes to the timer
sudo systemctl restart bedtime.timer
sudo systemctl status bedtime.timer

# for changes to the service
sudo systemctl restart bedtime.service
sudo systemctl status bedtime.service
----

==== Change the "Bedtime Zone"

* Edit `+SHUTDOWN_START+` and `+SHUTDOWN_END+` in `+/opt/bin/bedtime-shutdown.sh+`.
* Edit `+OnCalendar+` in `+/etc/systemd/system/bedtime.timer+` and reload/restart the timer as shown above.
* _Optional: If PAM time restriction is used, ensure the settings in `+/etc/security/time.conf+` are appropriate for your new "Bedtime Zone"._

==== Change the Grace Periods

* Edit `+GRACE_PERIOD_USER+` and `+GRACE_PERIOD_SYSTEM+` in `+/opt/bin/bedtime-shutdown.sh+`.

==== Enable Hardware Key Override

There are three options to prevent the shutdown on a given night using a "hardware key" like a USB stick or other removable media.

===== A. Using a Removable Media File

You can optionally use a USB stick or other removable media as a "hardware key" to prevent the shutdown on a given night while it is plugged in. To do so:

* Uncomment `+EMERGENCY_OVERRIDE_FILE_MEDIA_DIR+` in `+/opt/bin/bedtime-shutdown.sh+` and ensure that it points to the correct mount location for your system (default: `/media/$USER_NAME` on Ubuntu).
* Uncomment `+EMERGENCY_OVERRIDE_FILE_NAME+` in `+/opt/bin/bedtime-shutdown.sh+` and set it to your desired filename (default: `.bedtime-shutdown.emergency-override.$USER_NAME`).
* Create an empty file with that name on a USB stick or removable media (dir and file name as defined above): `touch /media/$USER_NAME/my-usb-stick/.bedtime-shutdown.emergency-override.$USER_NAME`

When the script runs, it will check if the specified file exists on any mounted media. If found, it aborts the shutdown process for that night.

===== B. Using a Removable Media Label

Alternatively, the script can just look for the LABEL of a removable media. To do so:

* Uncomment `+EMERGENCY_OVERRIDE_MEDIA_LABEL+` in `+/opt/bin/bedtime-shutdown.sh+` to your desired label (e.g., `BEDTIME-OVERRIDE`).
* Ensure that your USB stick or removable media is labeled accordingly.
** To check the label you can use `eject -l /dev/sdX` or `lsblk -f` (or `lsblk -fno LABEL | grep -v '^$'` for labels only).
** To set/change the label you can use e.g. `mlabel` (from `mtools`) or `gparted`

When the script runs, it will check if any mounted media has that label. If found, it aborts the shutdown process for that night.

===== C. Using a USB Device ID

You can also use a specific USB device ID as a hardware key to prevent shutdown. This can be any USB device like a flash drive, a YubiKey, an old WiFi/BT stick, or any other USB peripheral. To do so:

* Uncomment `+EMERGENCY_OVERRIDE_USB_ID+` in `+/opt/bin/bedtime-shutdown.sh+` and set it to the desired USB device ID (format: "1234:abcd").
** To find the device ID, use `lsusb -t`.

When the script runs, it will check if a USB device with that ID is connected. If found, it aborts the shutdown process for that night.

=== üí™ Hardening Tips

==== üîí Lock down the Script

In addition to setting the owner to root and permissions to `700` (see installation instructions above), you can make the script immutable to prevent any changes (even by root) unless the immutable flag is removed again:

[source,shell]
----
sudo chattr +i /opt/bin/bedtime-shutdown.sh
# Use `chattr -i` to remove the immutable flag again.
----

==== üîí Advanced Lock-in (PAM)

If you're worried you'll just sudo systemctl stop the timer when the warning pops up, you can use PAM to lock yourself out of authentication starting an hour before bedtime. This prevents new logins and sudo usage during the restricted window.

===== 1. Set the time restriction

Add a rule near the end of `+/etc/security/time.conf+` to block user (in this case `youruser`) between 21:00 and 05:00 (9:00 PM to 5:00 AM).

[source,shell]
----
sudo tee -a /etc/security/time.conf <<EOF

# Digital Detox: Prevent main user `youruser` from authenticating between 21:00 and 05:00 (30 min before bedtime)
*; *; youruser; !Al2100-0500
EOF
----

In this example we try to prevent tampering starting 30 min before our 21:30 (9:30 PM) bedtime timer is triggered (see above).

===== 2. Enable the PAM module

Edit `+/etc/pam.d/common-account+` and add the following line near tbe beginning to enforce these rules:

....
account    required    pam_time.so
....

WARNING: Be careful with this! If you are not already logged in, you won't be able to get back in until 6 AM.

=== ‚ùì Q&A

‚ùì *What about DST (Daylight Saving Time) changes?*

*Answer:* Both the script and the systemd timer uses local time, so DST changes are handled automatically. This is unless the system time zone is correctly set (e.g. `CET` and *not* `UTC`). You can use `timedatectl` to check or change the time zone. But in the end this is not a critical application, so a one-hour shift in shutdown time during DST transitions should not be a big deal. The important part is, that the script will still be executed and not skipped.

'''

=== nextcloud-maintenance.sh - üîß Nextcloud Maintenance Script

Intended for use in cron with cronic (for info mail) to perform maintenance tasks and integrity/update checks on nextcloud servers, or simply to run before/ahfter an update.

Stuff like:

* `occ db:add-missing-indices`
* `occ maintenance:repair`
* `occ integrity:check-core`
* `occ integrity:check-app "$app"`
* `occ app:update --all --showonly`
* `occ update:check`

'''

=== openvpn-client-cfg.sh

A small openvpn client cretificate and config helper tool

....
Usage:
  openvpn-client-cfg CLIENT_NAME [--ip IP] [--remote HOST] [--routes "NET1/MASK,NET2/MASK"] [--no-split] [--force]
  openvpn-client-cfg --list
  openvpn-client-cfg --delete CLIENT_NAME
  openvpn-client-cfg --revoke CLIENT_NAME

Options:
  --ip IP           Assign static IP via CCD (topology subnet; /24 mask assumed)
  --remote HOST     Override remote host (default: 11001001.org)
  --routes CSV      Extra routes for split-tunnel (e.g. "192.168.1.0/24,10.23.0.0/16")
  --no-split        Do NOT add route-nopull (internet / non-vpn traffic routed through vpn)
  --force|-f        Override safety checks (IP duplicate/subnet/CCD overwrite)

  --list|-l         List CCDs with optional IPs and cert expiry

  --delete|-d NAME  Disable a client by moving CCD to ccd.disabled (no revoke)
  --revoke|-r NAME  Revoke client's cert, refresh CRL, disable CCD

Example:
  # Create a new client configuration named "myworkstation" using static IP 10.10.0.5
  openvpn-client-cfg myworkstation --ip 10.10.0.5

Env overrides:
  EASYRSA_DIR=/home/cbaoth/openvpn-ca
  SERVER_CONF=/etc/openvpn/server/server.conf
  CCD_DIR=/etc/openvpn/ccd
  OUTPUT_DIR=/home/cbaoth
....

'''

=== audio-volume.sh

Toggle mute and change volume using hotkeys within the wm.

'''

=== backup.sh

Backup script with exclusion list, supports full and incremental backups.

'''

=== backup2ftp.sh

Upload last backup (made by backup.sh) to an ftp server, preserve previous backup on ftp.

'''

=== clear-cache.sh

Clean up home folder by removing (known) local caches, temp files etc.

'''

=== dbbackup.sh

Backup script for mysql and postgresql.

'''

=== gallery.sh

Create a very simple image gallery (static html file with static thumbs).

'''

=== pdfprint.sh

Print a pdf/ps file using psnup for multi page per sheet printing.

'''

=== smfetch.sn

Fetch rtmp / http(s) streams from some known (mostly german) tv stations and pages like youtube using wget and rtmpdump.

'''

=== wgetmp.py

Fetch multiple files in parallel using wget.

'''

=== getbyext.sh

Fetch all media files (or specific files by ext.) from a given url using wget.
