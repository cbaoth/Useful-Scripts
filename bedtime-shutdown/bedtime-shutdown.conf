# /etc/bedtime-shutdown.conf - Configuration for Bedtime Shutdown Service
# code: language=bash insertSpaces=true tabSize=2

# {{{ = CONFIGURATION ========================================================
# {{{ - Mandatory Settings ---------------------------------------------------
# Conigure the following (mandatory) variables to suit your needs.

# --- User Settings ---
# User to notify before shutdown
BSS_USER_NAME=$(id -nu 1000)    # Default: First non-root user (UID 1000)
#BSS_USER_NAME="your-username"  # Alternatively, set a specific username

# --- Logging ---
# Optional: Log file path for persistent logging (can be overridden via --logfile CLI option)
# If not set or empty, no log file will be used (output to stdout/stderr only)
#BSS_LOGFILE="/var/log/bedtime-shutdown.log"  # Requires write permissions (but script runs as root)
#BSS_LOGFILE="/tmp/bedtime-shutdown.log"      # Alternative for testing

# Minimum verbosity (0-4). If set, acts as a floor; CLI -v flags can only raise it.
# 0 = default (errors/warnings + critical messages), 1 = info, 2 = debug, 3 = debug (+set -v), 4 = debug (+set -x)
#BSS_VERBOSITY_MIN=0

# --- Grace Periods ---
# Grace period (seconds) between user notification and shutdown
#BSS_GRACE_PERIOD_USER=0         # Immediate shutdown without prior warning
BSS_GRACE_PERIOD_USER=300       # 5 minutes

# Grace period (seconds) between graceful poweroff attempt and forced poweroff
#BSS_GRACE_PERIOD_SYSTEM=0       # Disable forced poweroff fallback
BSS_GRACE_PERIOD_SYSTEM=300     # 5 minutes

# --- Shutdown schedule (24-hour format) ---
# Format: HHMM or HH:MM (24-hour format), e.g. `2130` or "21:30" = 21:30 (9:30 PM), `0500` or "05:00" = 5:00 (AM)
# The time the "Bedtime Zone" begins (Shutdown allowed)
BSS_SHUTDOWN_START="21:30"      # 21:30 (9:30 PM) start time

# The time the "Safe Zone" begins (Shutdown skipped)
BSS_SHUTDOWN_END="05:00"        # 05:00 (5:00 AM) end time
# }}} - Mandatory Settings ---------------------------------------------------

# {{{ - Optional Emergency Override Settings ---------------------------------
# Uncomment and adjust any of the following variables to enable emergency shutdown overrides.

# --- 1. File on USB Stick Override ---
# If a specific file is found on any mounted media, shutdown aborts.
# This override is ignored if the variables are not set.
# Adjust path to where USBs mount (Ubuntu: /media/$BSS_USER_NAME)
#BSS_EMERGENCY_OVERRIDE_FILE_MEDIA_DIR="/media/$BSS_USER_NAME"

# Adjust filename to look for on the USB stick
#BSS_EMERGENCY_OVERRIDE_FILE_NAME=".bedtime-shutdown.emergency-override.$BSS_USER_NAME"

# --- 2. USB Flash Drive Label Override ---
# If a USB flash drive (or any other block device) with this specific LABEL is plugged in, shutdown aborts.
# This override is ignored if the variable is not set.
# Use `lsblk -f` or `lsblk -fno LABEL | grep -v '^$'` to find the labels.
#BSS_EMERGENCY_OVERRIDE_BLOCK_DEVICE_LABEL="NO_SHUTDOWN"

# --- 3. USB Device ID Override ---
# If a USB device with this specific ID is plugged in, shutdown aborts.
# This override is ignored if the variable is not set.
# Use `lsusb` (e.g. `lsusb | grep -i realtek`) to find the device ID (format: "1234:abcd").
#BSS_EMERGENCY_OVERRIDE_USB_ID="abcd:1234"
# }}} - Optional Emergency Override Settings ---------------------------------

# {{{ - Optional Mount Cleanup Settings --------------------------------------
# Before the forced shutdown (--force --force), attempt to cleanly unmount specified filesystems
# to prevent dirty flags on NTFS/exFAT partitions or other filesystem corruption issues.
# This is a best-effort operation; errors are logged but won't prevent shutdown.

# --- Mount Points to Clean Up (supports glob patterns) ---
# Array of mount points or glob patterns to unmount before forced shutdown.
# Leave empty or unset to disable this feature.
# Examples:
#   BSS_CLEANUP_MOUNTS=("/mnt/data" "/mnt/backup")              # Specific mount points
#   BSS_CLEANUP_MOUNTS=("/mnt/[a-z]")                           # Single-letter mounts under /mnt/
#   BSS_CLEANUP_MOUNTS=("/mnt/*" "/media/$BSS_USER_NAME/*")    # All mounts under /mnt/ and user media
#BSS_CLEANUP_MOUNTS=("/mnt/data" "/mnt/backup")
#BSS_CLEANUP_MOUNTS=("/mnt/[a-z]")
BSS_CLEANUP_MOUNTS=()  # Empty = disabled (default)

# --- Unmount Strategy ---
# "lazy":       umount -l  (lazy unmount - removes from namespace, waits for I/O to complete)
# "force-lazy": umount -f -l  (force + lazy - more aggressive, useful for network mounts)
BSS_CLEANUP_STRATEGY="force-lazy"

# --- Pre-Unmount Actions ---
# Stop systemd automount units before unmounting to prevent re-mounting
BSS_CLEANUP_STOP_AUTOMOUNT=true

# Kill processes using the filesystems before unmounting (SIGTERM, then SIGKILL)
# This is essential for successful unmounting when processes are still accessing the filesystem
BSS_CLEANUP_KILL_PROCESSES=true

# --- Sync Parameters ---
# Number of sync calls to flush disk buffers after unmounting (recommended: 2-4)
# Main sync happens BEFORE unmount; this is an additional safety measure
BSS_CLEANUP_SYNC_COUNT=2

# Delay between sync calls in seconds
BSS_CLEANUP_SYNC_DELAY=1
# }}} - Optional Mount Cleanup Settings --------------------------------------
# }}} = CONFIGURATION ========================================================
